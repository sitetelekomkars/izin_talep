<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒ∞zin Talep Portalƒ± (Site Telekom)</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --ik-color: #7c3aed; --header-text: #1e293b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        
        /* ==============================
           SAYFA Gƒ∞Rƒ∞≈û Kƒ∞Lƒ∞T EKRANI STƒ∞Lƒ∞
           ============================== */
        #page-lock-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #f1f5f9;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .lock-card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            width: 100%;
            max-width: 350px;
        }
        .lock-input {
            width: 100%;
            padding: 15px;
            margin: 20px 0;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.1em;
            text-align: center;
            transition: 0.3s;
            box-sizing: border-box;
        }
        .lock-input:focus { border-color: var(--primary); outline: none; }
        .lock-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }
        .lock-btn:hover { background: #1d4ed8; transform: translateY(-2px); }

        /* ==============================
           ANA UYGULAMA STƒ∞LLERƒ∞
           ============================== */
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Header ve Logo Alanƒ± */
        .header-area {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 15px;
        }
        .logo-img {
            height: 60px; 
            width: auto;
            object-fit: contain;
        }
        .header-title {
            color: var(--header-text);
            margin: 0;
            font-size: 1.8em;
        }

        /* Navigasyon */
        .nav-buttons { display: flex; gap: 10px; margin-bottom: 20px; padding-bottom: 10px; }
        .nav-btn { flex: 1; padding: 15px; border: none; background: #e2e8f0; color: #64748b; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 1em; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .nav-btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .nav-btn.active[data-role="personel"] { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .nav-btn.active[data-role="yonetici"] { background: #f59e0b; color: white; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); }
        .nav-btn.active[data-role="ik"] { background: var(--ik-color); color: white; box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3); }

        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #334155; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 1em; transition: 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        
        button.submit-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1em; transition: 0.3s; }
        button.submit-btn:hover { background: #1d4ed8; }
        button.submit-btn:disabled { background: #94a3b8; cursor: not-allowed; }
        
        /* Admin Tablo Stilleri */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #e2e8f0; font-size: 0.95em; vertical-align: top; }
        th { background: #f8fafc; color: #64748b; text-transform: uppercase; font-size: 0.85em; letter-spacing: 0.5px; }
        tr:hover { background-color: #f8fafc; }

        /* Durum Etiketleri */
        .status { padding: 5px 10px; border-radius: 20px; font-size: 0.75em; font-weight: 800; display: inline-block; margin-bottom: 4px; letter-spacing: 0.5px; }
        .st-tl_bekliyor { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .st-ik_bekliyor { background: #f5f3ff; color: #6d28d9; border: 1px solid #ede9fe; }
        .st-onaylandi { background: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }
        .st-red { background: #fef2f2; color: #b91c1c; border: 1px solid #fee2e2; }

        .day-badge { background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 4px; font-size: 0.85em; font-weight: bold; margin-left: 5px; }
        .project-badge { background: #334155; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; margin-left: 5px; }

        .action-btn { padding: 6px 12px; margin-right: 5px; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.9em; transition: 0.2s; }
        .action-btn:hover { transform: scale(1.05); }
        .approve { background: #22c55e; } 
        .reject { background: #ef4444; }
        
        .hidden { display: none; }
        .loading { text-align: center; color: var(--primary); font-weight: bold; margin: 20px 0; }

        /* =========================================
           YENƒ∞ KART TASARIMI (Ge√ßmi≈ü ƒ∞zinler ƒ∞√ßin)
           ========================================= */
        .history-list { display: flex; flex-direction: column; gap: 15px; }
        
        .history-card {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            border-left: 6px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            transition: all 0.3s ease;
            position: relative;
        }
        .history-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }

        /* Kart Renkleri */
        .history-card.st-onaylandi { border-left-color: #22c55e; background: linear-gradient(to right, #f0fdf4, #fff); }
        .history-card.st-red { border-left-color: #ef4444; background: linear-gradient(to right, #fef2f2, #fff); }
        .history-card.st-tl_bekliyor { border-left-color: #f59e0b; }
        .history-card.st-ik_bekliyor { border-left-color: #7c3aed; }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .card-date { font-weight: 700; color: #1e293b; font-size: 1.1em; display: flex; align-items: center; gap: 8px; }
        .card-days-pill { background: #e2e8f0; color: #475569; font-size: 0.75em; padding: 4px 10px; border-radius: 20px; }

        .card-body { font-size: 1em; color: #475569; margin-bottom: 15px; line-height: 1.5; }
        .card-type { color: #0f172a; font-weight: 600; }

        .card-footer { 
            display: flex; justify-content: space-between; align-items: center; 
            border-top: 1px solid #f1f5f9; padding-top: 12px; margin-top: 5px; font-size: 0.9em; 
        }

        .approver-badge { 
            display: flex; align-items: center; gap: 6px; 
            background: #fff; border: 1px solid #cbd5e1; 
            padding: 5px 12px; border-radius: 30px; 
            color: #334155; font-weight: 600; font-size: 0.85em;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        /* Bakƒ±m Modu */
        #maintenance-screen {
            display: none; text-align: center; padding: 50px;
            background: white; max-width: 600px; margin: 50px auto;
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div id="page-lock-screen">
    <div class="lock-card">
        <img src="https://cdn-icons-png.flaticon.com/512/2942/2942544.png" alt="Logo" style="height: 80px; margin-bottom: 20px;">
        <h2 style="color: #1e293b; margin-bottom: 10px;">Site Telekom Portal</h2>
        <p style="color: #64748b; margin-bottom: 20px;">Eri≈üim i√ßin l√ºtfen ≈üifreyi giriniz.</p>
        <input type="password" id="page-pass" class="lock-input" placeholder="≈ûifre" onkeyup="checkEnter(event)">
        <button class="lock-btn" onclick="verifyPageAccess()">Giri≈ü Yap</button>
    </div>
</div>

<div id="maintenance-screen">
    <h1 style="font-size: 3em; margin-bottom: 10px;">üöß</h1>
    <h2 style="color: #1e293b;">Sistem Bakƒ±mda</h2>
    <p style="color: #64748b; font-size: 1.1em;">≈ûu an g√ºncelleme √ßalƒ±≈ümasƒ± yapƒ±lmaktadƒ±r.<br>L√ºtfen daha sonra tekrar deneyiniz.</p>
</div>

<div class="container" id="main-app" style="display: none;">
    
    <div class="header-area">
        <img src="https://cdn-icons-png.flaticon.com/512/2942/2942544.png" alt="Site Telekom Logo" class="logo-img">
        <h2 class="header-title">ƒ∞zin Y√∂netim Sistemi</h2>
    </div>
    
    <div class="nav-buttons">
        <button class="nav-btn active" data-role="personel" onclick="switchRole('personel')">üë§ Personel</button>
        <button class="nav-btn" data-role="yonetici" onclick="switchRole('yonetici')">üõ°Ô∏è Y√∂netici (TL)</button>
        <button class="nav-btn" data-role="ik" onclick="switchRole('ik')">üè¢ ƒ∞K</button>
    </div>

    <div id="personel-panel">
        <div class="panel-info" style="background:#eff6ff; padding:15px; border-radius:8px; color:#1e40af; margin-bottom:20px; border-left: 5px solid #2563eb;">
            üëã <strong>Ho≈ü Geldiniz!</strong> Yeni izin talebi olu≈üturabilir veya ge√ßmi≈ü izinlerinizi sorgulayabilirsiniz.
        </div>

        <form id="leaveForm" onsubmit="submitLeave(event)">
            <div class="form-group">
                <label>Ad Soyad</label>
                <input type="text" id="name" placeholder="Adƒ±nƒ±z ve Soyadƒ±nƒ±z" required>
            </div>
            
            <div class="form-group">
                <label>Proje</label>
                <select id="project" required>
                    <option value="" disabled selected>Se√ßiniz...</option>
                    <option value="TTNET">TTNET</option>
                    <option value="T√úRKNET">T√úRKNET</option>
                    <option value="OSK">OSK</option>
                    <option value="SSPORT">SSPORT</option>
                    <option value="T√úRKSAT">T√úRKSAT</option>
                </select>
            </div>

            <div class="form-group" style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>Ba≈ülangƒ±√ß</label>
                    <input type="date" id="startDate" onchange="calcDays()" required>
                </div>
                <div style="flex:1">
                    <label>Biti≈ü</label>
                    <input type="date" id="endDate" onchange="calcDays()" required>
                </div>
            </div>
            <div class="form-group">
                <label>Toplam: <span id="dayPreview" style="font-weight:normal">-</span></label>
            </div>
            <div class="form-group">
                <label>ƒ∞zin T√ºr√º</label>
                <select id="type">
                    <option value="Yƒ±llƒ±k ƒ∞zin">Yƒ±llƒ±k ƒ∞zin</option>
                    <option value="Hastalƒ±k">Hastalƒ±k Raporu</option>
                    <option value="Mazeret">Mazeret ƒ∞zni</option>
                    <option value="Babalƒ±k">Babalƒ±k ƒ∞zni</option>
                    <option value="Cenaze izni">Cenaze izni</option>
                    <option value="Diƒüer">Diƒüer</option>
                </select>
            </div>
            <div class="form-group">
                <label>A√ßƒ±klama</label>
                <textarea id="reason" rows="3" placeholder="ƒ∞zin nedeni..." required></textarea>
            </div>
            <button type="submit" class="submit-btn" id="btnSubmit">Talebi G√∂nder</button>
        </form>

        <div id="history-area" style="margin-top: 30px; border-top: 2px dashed #e2e8f0; padding-top: 20px;">
            <h4 style="display:flex; align-items:center; gap:10px;">üìÇ Ge√ßmi≈ü ƒ∞zinlerim</h4>
            <p style="font-size:0.9em; color:#64748b;">Adƒ±nƒ±zƒ± yazƒ±p butona basarak eski taleplerinizin durumunu g√∂rebilirsiniz.</p>
            <button type="button" style="background:#475569; color:white; border:none; padding:12px 25px; border-radius:8px; cursor:pointer; font-weight:bold; font-size:1em;" onclick="loadRequests('personel')">üîç Ge√ßmi≈üimi Getir</button>
            
            <div id="personelHistoryList" class="history-list hidden" style="margin-top:25px;"></div>
        </div>
    </div>

    <div id="admin-panel" class="hidden">
        <div id="admin-header" style="display:flex; flex-direction: column; gap:10px; margin-bottom:15px;">
            <div id="admin-msg" style="padding:10px; border-radius:6px; background:#fffbeb; color:#92400e;"></div>
            <div style="background:#f1f5f9; padding:10px; border-radius:6px; font-size:0.95em; display:flex; justify-content:space-between; align-items:center;">
                <span>üë§ Giri≈ü Yapan: <strong id="activeAdminName" style="color:#0f172a;"></strong></span>
                <span id="activeProjectBadge" style="display:none; background:#334155; color:white; padding:2px 8px; border-radius:4px; font-size:0.85em;"></span>
            </div>
        </div>
        
        <div id="loader" class="loading hidden">
            <div style="display:inline-block; width:20px; height:20px; border:3px solid #f3f3f3; border-top:3px solid var(--primary); border-radius:50%; animation: spin 1s linear infinite;"></div>
            Veriler Y√ºkleniyor...
        </div>
        
        <table id="requestsTable">
            <thead>
                <tr>
                    <th style="width:25%">Personel / Proje</th>
                    <th style="width:25%">Tarih / G√ºn</th>
                    <th style="width:30%">T√ºr / A√ßƒ±klama</th>
                    <th style="width:20%">Durum / ƒ∞≈ülem</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<style>
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<script>
    // ==========================================
    // üîí SAYFA Gƒ∞Rƒ∞≈û ≈ûƒ∞FRESƒ∞ AYARI
    // ==========================================
    const PAGE_PASSWORD = "3636";
    
    // ==========================================
    // üöß BAKIM MODU AYARI (A√ßmak i√ßin true yap)
    // ==========================================
    const BAKIM_MODU = false; 
    // ==========================================

    function checkEnter(e) {
        if(e.key === "Enter") verifyPageAccess();
    }

    function verifyPageAccess() {
        const input = document.getElementById('page-pass').value;
        if (input === PAGE_PASSWORD) {
            // ≈ûifre Doƒüru
            document.getElementById('page-lock-screen').style.display = 'none'; // Kilidi kaldƒ±r
            
            if (BAKIM_MODU) {
                // Bakƒ±m modu a√ßƒ±ksa bakƒ±m ekranƒ±nƒ± g√∂ster
                document.getElementById('maintenance-screen').style.display = 'block';
                document.body.style.background = "#e2e8f0";
            } else {
                // Her ≈üey normalse ana uygulamayƒ± g√∂ster
                document.getElementById('main-app').style.display = 'block';
            }
        } else {
            // ≈ûifre Yanlƒ±≈ü
            Swal.fire({
                icon: 'error',
                title: 'Hatalƒ± ≈ûifre',
                text: 'L√ºtfen tekrar deneyiniz.',
                confirmButtonColor: '#ef4444'
            });
        }
    }

    // ==========================================
    // MEVCUT UYGULAMA KODLARI
    // ==========================================

    const API_URL = "https://script.google.com/macros/s/AKfycby1QGB4lpO_VRt-PYCORj9DggoYvvwGPcSxGq4gTD9deYPpyNQr1bjMwncaKW6hGxgeSw/exec";
    
    const YONETICI_SIFRE = "36487"; 
    const IK_SIFRE = "snn128936";        

    let currentRole = 'personel';
    let currentAdminName = '';
    let currentAdminProject = ''; // Y√∂netici projesini tutacak deƒüi≈üken

    async function switchRole(role) {
        currentAdminName = '';
        currentAdminProject = '';
        document.getElementById('activeAdminName').innerText = '';
        document.getElementById('activeProjectBadge').style.display = 'none';

        if (role === 'personel') {
            activateTab(role);
            return;
        }

        let targetPassword = (role === 'yonetici') ? YONETICI_SIFRE : IK_SIFRE;
        let roleTitle = (role === 'yonetici') ? 'Y√∂netici (TL) Giri≈üi' : 'ƒ∞K Giri≈üi';
        let roleColor = (role === 'yonetici') ? '#f59e0b' : '#7c3aed';

        // 1. ADIM: ≈ûƒ∞FRE KONTROL√ú
        const { value: password } = await Swal.fire({
            title: roleTitle,
            text: 'L√ºtfen giri≈ü ≈üifresini giriniz',
            input: 'password',
            inputPlaceholder: '≈ûifre',
            confirmButtonText: 'Devam Et',
            confirmButtonColor: roleColor,
            showCancelButton: true,
            cancelButtonText: 'ƒ∞ptal',
            backdrop: `rgba(0,0,0,0.4)`
        });

        if (!password) return;

        if (password !== targetPassword) {
            Swal.fire({ icon: 'error', title: 'Hatalƒ± ≈ûifre!', text: 'Girdiƒüiniz ≈üifre yanlƒ±≈ü.', confirmButtonColor: '#ef4444' });
            return;
        }

        // 2. ADIM: Bƒ∞LGƒ∞ FORMU (AD, SOYAD, PROJE)
        // TL i√ßin proje se√ßimi zorunlu, ƒ∞K i√ßin opsiyonel veya hepsi olabilir.
        // Burada TL i√ßin √∂zel form yapƒ±sƒ± kuruyoruz.
        
        let htmlContent = `
            <input id="swal-name" class="swal2-input" placeholder="Adƒ±nƒ±z">
            <input id="swal-surname" class="swal2-input" placeholder="Soyadƒ±nƒ±z">
        `;

        // Sadece y√∂netici ise Proje se√ßimi ekle
        if (role === 'yonetici') {
            htmlContent += `
                <select id="swal-project" class="swal2-select" style="display:flex; width:80%; margin: 10px auto;">
                    <option value="" disabled selected>Projenizi Se√ßiniz</option>
                    <option value="TTNET">TTNET</option>
                    <option value="T√úRKNET">T√úRKNET</option>
                    <option value="OSK">OSK</option>
                    <option value="SSPORT">SSPORT</option>
                    <option value="T√úRKSAT">T√úRKSAT</option>
                </select>
            `;
        }

        const { value: formValues } = await Swal.fire({
            title: 'Giri≈ü Bilgileri',
            html: htmlContent,
            focusConfirm: false,
            confirmButtonText: 'Panele Gir',
            confirmButtonColor: roleColor,
            preConfirm: () => {
                const name = document.getElementById('swal-name').value;
                const surname = document.getElementById('swal-surname').value;
                let project = "";
                
                if (role === 'yonetici') {
                    project = document.getElementById('swal-project').value;
                    if (!project) {
                        Swal.showValidationMessage('L√ºtfen projenizi se√ßiniz');
                        return false;
                    }
                }

                if (!name || !surname) {
                    Swal.showValidationMessage('Ad ve Soyad alanlarƒ± zorunludur');
                    return false;
                }

                return { name: name, surname: surname, project: project };
            }
        });

        if (formValues) {
            currentAdminName = `${formValues.name} ${formValues.surname}`; // Ad Soyad birle≈ütir
            currentAdminProject = formValues.project; // Projeyi kaydet
            
            document.getElementById('activeAdminName').innerText = currentAdminName;
            
            if(currentAdminProject) {
                const pBadge = document.getElementById('activeProjectBadge');
                pBadge.innerText = currentAdminProject + " Ekibi";
                pBadge.style.display = "inline-block";
            }
            
            activateTab(role);
        }
    }

    function activateTab(role) {
        currentRole = role;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`[data-role="${role}"]`).classList.add('active');
        document.getElementById('personel-panel').classList.toggle('hidden', role !== 'personel');
        document.getElementById('admin-panel').classList.toggle('hidden', role === 'personel');

        if(role !== 'personel') {
            const msg = document.getElementById('admin-msg');
            if(role === 'yonetici') {
                msg.innerHTML = `üõ°Ô∏è <strong>Y√∂netici Paneli (${currentAdminProject}):</strong> Sadece <u>${currentAdminProject}</u> projesindeki talepleri g√∂r√ºyorsunuz.`;
                msg.style.background = "#fff7ed"; msg.style.color = "#c2410c";
            } else {
                msg.innerHTML = "üè¢ <strong>ƒ∞K Paneli:</strong> T√ºm projelerdeki talepleri y√∂netebilirsiniz.";
                msg.style.background = "#f5f3ff"; msg.style.color = "#6d28d9";
            }
            loadRequests('admin');
        }
    }

    function calcDays() {
        const s = document.getElementById('startDate').value;
        const e = document.getElementById('endDate').value;
        const p = document.getElementById('dayPreview');
        if(s && e) {
            const diff = new Date(e) - new Date(s);
            const days = Math.ceil(diff / (1000*60*60*24)) + 1;
            if(days > 0) {
                p.innerText = days + " G√ºn";
                p.style.color = "var(--primary)";
                p.style.fontWeight = "bold";
            } else {
                p.innerText = "Hatalƒ± Tarih";
                p.style.color = "red";
            }
        }
    }

    function submitLeave(e) {
        e.preventDefault();
        const btn = document.getElementById('btnSubmit');
        const s = document.getElementById('startDate').value;
        const e_date = document.getElementById('endDate').value;
        const days = Math.ceil((new Date(e_date) - new Date(s)) / (1000*60*60*24)) + 1;

        if(days <= 0) { Swal.fire('Hata', 'Biti≈ü tarihi ba≈ülangƒ±√ßtan √∂nce olamaz.', 'error'); return; }

        btn.disabled = true; btn.innerText = "G√∂nderiliyor...";

        const data = {
            action: 'create',
            id: Date.now(),
            name: document.getElementById('name').value.trim(),
            project: document.getElementById('project').value,
            start: s, end: e_date, days: days,
            type: document.getElementById('type').value,
            reason: document.getElementById('reason').value,
            status: 'tl_bekliyor'
        };

        fetch(API_URL, { method: "POST", body: JSON.stringify(data) })
        .then(() => {
            Swal.fire({ icon: 'success', title: 'Ba≈üarƒ±lƒ±!', text: 'ƒ∞zin talebiniz y√∂netici onayƒ±na g√∂nderildi.', timer: 3000, showConfirmButton: false });
            document.getElementById('leaveForm').reset();
            document.getElementById('dayPreview').innerText = "-";
            btn.disabled = false; btn.innerText = "Talebi G√∂nder";
        }).catch(err => { Swal.fire('Hata', 'Sunucu hatasƒ±: ' + err, 'error'); btn.disabled = false; });
    }

    function loadRequests(mode) {
        let fetchUrl = API_URL;
        if (mode === 'personel') {
            const nameVal = document.getElementById('name').value.trim();
            if(!nameVal) { Swal.fire('Uyarƒ±','L√ºtfen √∂nce yukarƒ±ya Ad Soyad giriniz.','warning'); return; }
            fetchUrl += "?name=" + encodeURIComponent(nameVal);
            
            const listContainer = document.getElementById('personelHistoryList');
            listContainer.classList.remove('hidden');
            listContainer.innerHTML = '<div style="text-align:center; padding:20px; font-size:1.2em;">‚è≥ Ge√ßmi≈ü Y√ºkleniyor...</div>';

            fetch(fetchUrl).then(res => res.json()).then(data => {
                listContainer.innerHTML = '';
                if(data.length === 0) { listContainer.innerHTML = '<div style="text-align:center; padding:10px; color:#94a3b8;">Kayƒ±t bulunamadƒ±.</div>'; return; }
                
                data.reverse().forEach(req => {
                    let footerContent = "";
                    if(req.status === 'red') {
                        footerContent = `<span style="color:#ef4444; font-weight:bold;">üõë Red Sebebi: ${req.reject_reason || '-'}</span>`;
                    } else if (req.approver) {
                        footerContent = `<div class="approver-badge"><span style="color:#22c55e">‚úî</span> Onaylayan: ${req.approver}</div>`;
                    } else {
                        footerContent = `<span style="color:#f59e0b; font-style:italic;">‚è≥ ƒ∞≈ülem Bekleniyor</span>`;
                    }

                    const cardHtml = `
                        <div class="history-card st-${req.status}">
                            <div class="card-header">
                                <div class="card-date">
                                    üìÖ ${formatDate(req.start)} - ${formatDate(req.end)}
                                    <span class="card-days-pill">${req.days} G√ºn</span>
                                </div>
                                <div class="status st-${req.status}">${getStatusName(req.status)}</div>
                            </div>
                            <div class="card-body">
                                <div class="card-type">${req.type}</div>
                                <div>${req.reason}</div>
                            </div>
                            <div class="card-footer">
                                ${footerContent}
                            </div>
                        </div>
                    `;
                    listContainer.innerHTML += cardHtml;
                });
            });
        } else {
            const loader = document.getElementById('loader');
            const tbody = document.getElementById('tableBody');
            loader.classList.remove('hidden');
            tbody.innerHTML = '';

            fetch(API_URL).then(res => res.json()).then(data => {
                loader.classList.add('hidden');
                
                // ==========================================
                // üéØ Fƒ∞LTRELEME MANTIƒûI BURADA
                // ==========================================
                let filteredData = data;

                // Eƒüer giri≈ü yapan Y√ñNETƒ∞Cƒ∞ ise, sadece kendi projesini g√∂rs√ºn
                if (currentRole === 'yonetici' && currentAdminProject) {
                    filteredData = data.filter(req => req.project === currentAdminProject);
                }
                // ƒ∞K ise filtreleme yapma (hepsini g√∂rs√ºn)

                if(filteredData.length === 0) { 
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Bu projede bekleyen talep yok.</td></tr>'; 
                    return; 
                }
                
                filteredData.reverse().forEach(req => renderAdminRow(req, tbody));
            });
        }
    }

    function renderAdminRow(req, tbody) {
        let actionHtml = '';
        if(currentRole === 'yonetici' && req.status === 'tl_bekliyor') {
            actionHtml = `<button class="action-btn approve" onclick="updateStatus(${req.id}, 'ik_bekliyor')" title="Onayla">‚úî</button>
                          <button class="action-btn reject" onclick="rejectRequest(${req.id})" title="Reddet">‚úñ</button>`;
        } else if(currentRole === 'ik' && req.status === 'ik_bekliyor') {
            actionHtml = `<button class="action-btn approve" onclick="updateStatus(${req.id}, 'onaylandi')" title="Bitir">‚úî</button>
                          <button class="action-btn reject" onclick="rejectRequest(${req.id})" title="Reddet">‚úñ</button>`;
        } else {
            actionHtml = `<span class="status st-${req.status}">${getStatusName(req.status)}</span>`;
        }

        let details = "";
        if(req.status === 'red' && req.reject_reason) { details += `<span class="reject-reason">Red Nedeni: ${req.reject_reason}</span>`; }
        if(req.approver) { details += `<div class="audit-info">üìù ${req.approver}</div>`; }

        const projectName = req.project ? req.project : "";

        const row = `
            <tr>
                <td><strong style="color:#1e293b;">${req.name}</strong><br>${projectName ? `<span class="project-badge">${projectName}</span>` : ''}</td>
                <td>${formatDate(req.start)} <span class="day-badge">${req.days} G</span></td>
                <td>${req.type}<br><small style="color:#64748b; font-style:italic;">"${req.reason}"</small></td>
                <td>${actionHtml}${details}</td>
            </tr>
        `;
        tbody.innerHTML += row;
    }

    async function rejectRequest(id) {
        const { value: reason } = await Swal.fire({
            title: 'Reddetme Sebebi', input: 'text', inputLabel: 'L√ºtfen red sebebini giriniz:',
            inputPlaceholder: '√ñrn: Yoƒüunluk nedeniyle...', showCancelButton: true,
            confirmButtonColor: '#ef4444', confirmButtonText: 'Reddet', cancelButtonText: 'ƒ∞ptal',
            inputValidator: (value) => { if (!value) { return 'Sebep yazmanƒ±z gerekmektedir!' } }
        });
        if (reason) { updateStatus(id, 'red', reason); }
    }

    function updateStatus(id, status, rejectReason = "") {
        if(status !== 'red') {
             Swal.fire({
                title: 'Emin misiniz?', text: "Bu i≈ülemi onaylƒ±yor musunuz?", icon: 'question',
                showCancelButton: true, confirmButtonColor: '#22c55e', cancelButtonColor: '#d33',
                confirmButtonText: 'Evet, Onayla', cancelButtonText: 'Vazge√ß'
            }).then((result) => { if (result.isConfirmed) { executeStatusUpdate(id, status, rejectReason); } });
        } else { executeStatusUpdate(id, status, rejectReason); }
    }

    function executeStatusUpdate(id, status, rejectReason) {
        document.getElementById('loader').classList.remove('hidden');
        const payload = { action: 'update', id: id, status: status, approver: currentAdminName, rejectReason: rejectReason };
        fetch(API_URL, { method: "POST", body: JSON.stringify(payload) }).then(() => {
            loadRequests('admin');
            const msg = status === 'red' ? 'Talep reddedildi.' : 'ƒ∞≈ülem ba≈üarƒ±yla tamamlandƒ±.';
            Swal.fire('Tamamlandƒ±!', msg, 'success');
        });
    }

    function formatDate(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString);
        if (isNaN(date.getTime())) { return dateString.split('-').reverse().join('.'); }
        return date.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function getStatusName(s) {
        const map = { 'tl_bekliyor': 'TL Onayƒ±', 'ik_bekliyor': 'ƒ∞K Onayƒ±', 'onaylandi': 'Tamamlandƒ±', 'red': 'Reddedildi' };
        return map[s] || s;
    }
</script>

</body>
</html>
